<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Metatags for character set, viewport, and compatibility -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Favicon and Apple Touch Icon -->
    <link
      rel="shortcut icon"
      href="assets/img/UN_Habitat_Icon.svg"
      type="image/x-icon"
    />
    <!-- Page Title -->
    <title>Assign Role Permission</title>
    <!-- Fonts and icons -->
    <link href="libraries/css/inter.css" rel="stylesheet" />
    <!-- Font Awesome Icons -->
    <link href="libraries/css/fontawesome-6.5.1.min.css" rel="stylesheet" />
    <!-- CSS Files -->
    <link
      id="pagestyle"
      href="assets/css/soft-ui-dashboard.css?v=1.1.0"
      rel="stylesheet"
    />

    <!-- Simplified Arabic Font -->
    <link
      href="libraries/fonts/google-fonts/noto-naskh-arabic.css"
      rel="stylesheet"
    />
    <!-- Github buttons -->
    <!-- Common User Functions -->

    <script src="assets/js/common-user-functions.js"></script>

    <script src="libraries/js/buttons.js" async defer></script>
    <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="libraries/js/soft-ui-dashboard-1.1.0.min.js"></script>
    <!--   Core JS Files   -->
    <script src="libraries/js/popper-2.11.8.min.js"></script>
    <script src="libraries/js/bootstrap-5.3.2.min.js"></script>
    <script src="libraries/js/perfect-scrollbar-1.5.5.min.js"></script>
    <script src="libraries/js/smooth-scrollbar-8.8.4.js"></script>
    <script src="libraries/js/chart-4.4.1.umd.min.js"></script>

    <!-- Common styles -->
    <link href="assets/css/styles.css" rel="stylesheet" />

    <style>
      /* Page-specific styles for assign-role-permission.html */

      .menu-item i {
        margin-left: 8px;
        width: 20px;
        text-align: center;
      }

      .menu-item:hover {
        background-color: #f5f5f5;
      }

      body[dir="ltr"] .menu-dropdown-content {
        right: auto;
        left: 0;
      }

      body[dir="ltr"] .menu-item i {
        margin-left: 0;
        margin-right: 8px;
      }

      /* Enhanced Table Header Styles */
      .card-header h6 {
        font-size: 1.5rem !important;
        font-weight: 700 !important;
        color: #344767 !important;
        margin-bottom: 0.5rem !important;
      }

      .table thead th {
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        color: #344767 !important;
        padding: 1rem 0.75rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
        border-bottom: 2px solid #e9ecef !important;
        background-color: #f8f9fa !important;
      }

      .table thead th.text-uppercase {
        font-size: 1.1rem !important;
        font-weight: 600 !important;
      }

      /* Card and chart styles */
      .card {
        border-radius: 1rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        background-color: linear-gradient(135deg, #e3f2fd, #ffffff);
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 200px;
        padding: 1.5rem;
      }

      .card-title {
        margin-bottom: 1rem;
      }

      .card-text {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0;
      }

      .chart-container {
        height: 100%;
        min-height: 200px;
      }

      canvas {
        width: 100% !important;
        height: 100% !important;
      }

      /* Font Awesome icon styles */
      .fa,
      .fab,
      .fas,
      .far,
      i.fa,
      i.fab,
      i.fas,
      i.far,
      i.fa-facebook-f,
      i.fa-x-twitter,
      i.fa-instagram,
      i.fa-linkedin-in,
      i.fa-whatsapp {
        font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
        display: inline-block !important;
        visibility: visible !important;
      }

      /* Notification styles */
      #notificationContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 350px;
      }

      .notification {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease-out;
        position: relative;
        overflow: hidden;
      }

      .notification.success {
        background-color: #d4edda;
        border-left: 4px solid #28a745;
        color: #155724;
      }

      .notification.error {
        background-color: #f8d7da;
        border-left: 4px solid #dc3545;
        color: #721c24;
      }

      .notification.info {
        background-color: #d1ecf1;
        border-left: 4px solid #17a2b8;
        color: #0c5460;
      }

      .notification.warning {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404;
      }

      .notification-icon {
        font-size: 20px;
        margin-left: 12px;
        margin-right: 0;
      }

      .notification-content {
        flex: 1;
      }

      .notification-title {
        font-weight: bold;
        margin-bottom: 4px;
      }

      .notification-message {
        font-size: 14px;
        margin: 0;
      }

      .notification-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        margin-right: 5px;
        margin-left: 0;
        opacity: 0.7;
      }

      .notification-close:hover {
        opacity: 1;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .notification.slide-out {
        animation: slideOut 0.3s ease-in forwards;
      }

      /* RTL/LTR specific styles */
      body[dir="ltr"] #notificationContainer {
        right: auto;
        left: 20px;
      }

      body[dir="ltr"] .notification-icon {
        margin-left: 0;
        margin-right: 12px;
      }

      body[dir="ltr"] .notification-close {
        margin-right: 0;
        margin-left: 5px;
      }

      body[dir="ltr"] .notification {
        animation: slideInLTR 0.3s ease-out;
      }

      body[dir="ltr"] .notification.slide-out {
        animation: slideOutLTR 0.3s ease-in forwards;
      }

      @keyframes slideInLTR {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutLTR {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(-100%);
          opacity: 0;
        }
      }

      /* Multi-select dropdown styling */
      .permissions-select {
        width: 100%;
        min-height: 120px;
        max-height: 150px;
        border: 1px solid #d1ecf1;
        border-radius: 8px;
        padding: 8px;
        background-color: #f8f9fa;
        font-size: 12px;
        transition: all 0.3s ease;
        overflow-y: auto;
        resize: vertical;
      }

      .permissions-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
      }

      .permissions-select option {
        padding: 8px 10px;
        margin: 2px 0;
        border-radius: 4px;
        transition: all 0.2s ease;
        cursor: pointer;
        display: block;
        line-height: 1.4;
      }

      .permissions-select option:checked {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20c997 100%
        ) !important;
        color: white !important;
        font-weight: bold;
        border: 2px solid #155724;
      }

      .permissions-select option:hover {
        background-color: #e3f2fd !important;
        color: #0056b3;
      }

      .permissions-select option:checked:hover {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e7e34 100%
        ) !important;
        color: white !important;
      }

      /* Instructions text */
      .select-instructions {
        font-size: 10px;
        color: #6c757d;
        margin-top: 5px;
        text-align: center;
        font-style: italic;
      }

      /* Count badge styling */
      .count-badge {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
      }

      .count-badge i {
        font-size: 12px;
      }

      /* Role name styling */
      .role-name-cell {
        font-weight: bold;
        color: #2c3e50;
        font-size: 15px;
      }

      .role-description {
        color: #6c757d;
        font-size: 12px;
        font-style: italic;
        margin-top: 2px;
      }

      /* Table row hover effects */
      #rolePermissionsTableBody tr {
        transition: all 0.3s ease;
      }

      #rolePermissionsTableBody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* Improved table cell padding */
      #rolePermissionsTableBody td {
        padding: 15px 12px;
        vertical-align: middle;
      }

      /* Table header improvements */
      #rolePermissionsTable thead th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      /* Loading spinner */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Save button styling */
      .save-changes-btn {
        position: sticky;
        bottom: 20px;
        margin: 20px auto;
        display: block;
        z-index: 1000;
      }
    </style>
  </head>

  <body class="g-sidenav-show bg-gray-100">
    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Header -->
    <header id="mainHeader">
      <div style="display: flex; align-items: center; gap: 10px">
        <img
          src="assets/img/aleppo.jfif"
          alt="Logo 1"
          class="header-logo"
          onclick="window.location.href = './welcome.html';"
          style="cursor: pointer"
          title="Aleppo Governorate"
        />
      </div>

      <div class="header-title text-center">
        <div class="title-ar">نظام إدارة المعلومات الحضرية _ مدينة حلب</div>
        <div class="title-en">
          Urban Information Management System - Aleppo City
        </div>
      </div>

      <div class="header-logos right-logos">
        <div class="menu-dropdown">
          <button
            class="menu-toggle"
            id="menuToggleBtn"
            onclick="toggleMenu()"
          ></button>
          <div class="menu-dropdown-content" id="menuDropdown">
            <a
              href="#"
              class="menu-item"
              id="langToggleBtn"
              onclick="toggleLanguage();"
            >
              <i class="fas fa-language"></i>
              <span id="langToggleText">تغيير اللغة</span>
            </a>
            <a
              href="#"
              class="menu-item"
              id="settingsBtn"
              onclick="window.location.href = './profile.html';"
            >
              <i class="fas fa-cog"></i>
              <span id="settingsText">الإعدادات</span>
            </a>
            <a
              href="#"
              class="menu-item"
              id="logoutBtn"
              onclick="logoutUser();"
            >
              <i class="fas fa-sign-out-alt"></i>
              <span id="logoutText">تسجيل الخروج</span>
            </a>
          </div>
        </div>
          <img
            src="assets/img/unhabitat.png"
            alt="Logo 3"
            class="header-logo"
            title="UN Habitat"
            style="background-color: #fff;"
          />
        <img src="assets/img/japan.jpg" alt="Logo 2" class="header-logo" title="From the People of Japanese "/>
      </div>
    </header>

    <aside
      class="sidenav navbar navbar-vertical navbar-expand-xs border-0 my-3 fixed-end bg-gray-300"
      id="sidenav-main"
      style="max-height: calc(100vh - 66px); overflow-y: visible"
    >
      <div class="sidenav-header">
        <i
          class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
          aria-hidden="true"
          id="iconSidenav"
        ></i>
      </div>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <div
                class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 ms-2 d-flex align-items-center justify-content-center"
              >
                <i
                  class="fas fa-tachometer-alt"
                  style="color: black; font-size: 20px"
                ></i>
              </div>
              <span class="nav-link-text ms-1">Dashboard</span>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="tables.html">
              <div
                class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 ms-2 d-flex align-items-center justify-content-center"
              >
                <i
                  class="fas fa-table"
                  style="color: black; font-size: 20px"
                ></i>
              </div>
              <span class="nav-link-text ms-1">configuration Tables </span>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link active" href="ManageUsers.html">
              <div
                class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 ms-2 d-flex align-items-center justify-content-center"
                style="
                  background: linear-gradient(
                    135deg,
                    #007bff 0%,
                    #0056b3 100%
                  ) !important;
                "
              >
                <i
                  class="fas fa-users-cog"
                  style="color: white; font-size: 20px"
                ></i>
              </div>
              <span class="nav-link-text ms-1">Manage users</span>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="neighborhoodCommitteesManagement.html">
              <div
                class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 ms-2 d-flex align-items-center justify-content-center"
              >
                <i
                  class="fas fa-users"
                  style="color: black; font-size: 20px"
                ></i>
              </div>
              <span class="nav-link-text ms-1">إدارة لجان الأحياء</span>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="developmentCommitteesManagement.html">
              <div
                class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 ms-2 d-flex align-items-center justify-content-center"
              >
                <i
                  class="fas fa-chart-line"
                  style="color: black; font-size: 20px"
                ></i>
              </div>
              <span class="nav-link-text ms-1">إدارة لجان التنمية</span>
            </a>
          </li>
        </ul>
      </div>
      <div class="sidenav-footer mx-3"></div>
    </aside>
    <!-- Main Content Area -->
    <main
      class="main-content position-relative max-height-vh-100 h-100 border-radius-lg"
    >
      <!-- Demo Mode Notice -->
      <div class="container-fluid py-2">
        <div class="alert alert-info alert-dismissible fade show" role="alert" id="demoModeNotice">
          <i class="fas fa-info-circle me-2"></i>
          <strong id="demoModeTitle">وضع التجربة:</strong> 
          <span id="demoModeText">هذه الصفحة تعمل بدون خادم خلفي. جميع البيانات محفوظة محلياً في المتصفح.</span>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>
      
      <!-- Table Section for Assigning Role Permissions -->
      <div class="container-fluid py-4">
        <!-- Bootstrap container with padding -->
        <div class="row">
          <div class="col-12">
            <!-- Full-width column -->
            <div class="card mb-4 mt-5">
              <!-- Card with margin bottom and top -->
              <!-- Card Header -->
              <div
                class="card-header pb-0 d-flex justify-content-between align-items-center"
              >
                <!-- Card header with no bottom padding -->
                <h6 id="pageTitle">ربط الأدوار بالسماحيات</h6>
                <div class="d-flex gap-2">
                  <button
                    class="btn btn-success btn-sm"
                    onclick="saveAllChanges()"
                    style="
                      background: linear-gradient(
                        135deg,
                        #28a745 0%,
                        #20c997 100%
                      );
                      border: none;
                      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
                    "
                  >
                    <i class="fas fa-save"></i>
                    <span id="saveChangesText">حفظ التغييرات</span>
                  </button>
                  <button
                    class="btn btn-warning btn-sm"
                    onclick="resetToDefault()"
                    style="
                      background: linear-gradient(
                        135deg,
                        #ffc107 0%,
                        #fd7e14 100%
                      );
                      border: none;
                      box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
                    "
                    title="إعادة تعيين البيانات إلى الحالة الافتراضية"
                  >
                    <i class="fas fa-undo"></i>
                    <span>إعادة تعيين</span>
                  </button>
                </div>
              </div>
              <!-- Card Body -->
              <div class="card-body px-0 pt-0 pb-2">
                <!-- Card body with specific padding -->
                <!-- Loading indicator -->
                <div id="loadingIndicator" class="text-center p-4">
                  <div class="loading"></div>
                  <p class="mt-2">جاري التحميل...</p>
                </div>
                <!-- Table Responsive Wrapper -->
                <div
                  class="table-responsive p-0"
                  id="tableContainer"
                  style="display: none"
                >
                  <!-- Responsive table with no padding -->
                  <table class="table align-items-center mb-0">
                    <!-- Bootstrap table -->
                    <!-- Table Header -->
                    <thead>
                      <tr>
                        <!-- Role Name Column -->
                        <th
                          class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                        >
                          <span id="roleNameHeader">اسم الدور</span>
                        </th>
                        <!-- Current Permissions Column -->
                        <th
                          class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                        >
                          <span id="currentPermissionsHeader"
                            ><i class="fas fa-chart-bar me-1"></i>عدد
                            السماحيات</span
                          >
                        </th>
                        <!-- Available Permissions Column -->
                        <th
                          class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                        >
                          <span id="availablePermissionsHeader"
                            ><i class="fas fa-list-check me-1"></i>اختيار
                            السماحيات</span
                          >
                        </th>
                      </tr>
                    </thead>
                    <!-- Table Body -->
                    <tbody id="rolePermissionsTableBody">
                      <!-- Dynamic content will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="fixed-plugin">
      <a
        id="helpButton"
        class="fixed-plugin-button text-dark position-fixed px-3 py-2"
        style="bottom: 40px; z-index: 6000"
      >
        <i class="fa fa-question-circle py-2"> </i>
      </a>
    </div>

    <script>
      // Global variables
      let roles = [];
      let permissions = [];
      let rolePermissions = [];

      // Mock data for roles
      const mockRoles = [
        {
          id: 1,
          role_name: "مدير النظام",
          description: "صلاحيات كاملة على النظام"
        },
        {
          id: 2,
          role_name: "مشرف",
          description: "إدارة المستخدمين والمحتوى"
        },
        {
          id: 3,
          role_name: "محرر",
          description: "تحرير المحتوى والبيانات"
        },
        {
          id: 4,
          role_name: "مشاهد",
          description: "عرض البيانات فقط"
        },
        {
          id: 5,
          role_name: "محلل بيانات",
          description: "تحليل البيانات والتقارير"
        }
      ];

      // Mock data for permissions
      const mockPermissions = [
        { id: 1, permission_name: "إدارة المستخدمين" },
        { id: 2, permission_name: "إدارة الأدوار" },
        { id: 3, permission_name: "إدارة السماحيات" },
        { id: 4, permission_name: "عرض البيانات" },
        { id: 5, permission_name: "تحرير البيانات" },
        { id: 6, permission_name: "حذف البيانات" },
        { id: 7, permission_name: "إنشاء التقارير" },
        { id: 8, permission_name: "تصدير البيانات" },
        { id: 9, permission_name: "إدارة الخرائط" },
        { id: 10, permission_name: "إدارة المشاريع" },
        { id: 11, permission_name: "إدارة اللجان" },
        { id: 12, permission_name: "إعدادات النظام" }
      ];

      // Mock data for role permissions (initial assignments)
      const mockRolePermissions = [
        { id: 1, role: 1, permission: 1 }, // مدير النظام - إدارة المستخدمين
        { id: 2, role: 1, permission: 2 }, // مدير النظام - إدارة الأدوار
        { id: 3, role: 1, permission: 3 }, // مدير النظام - إدارة السماحيات
        { id: 4, role: 1, permission: 4 }, // مدير النظام - عرض البيانات
        { id: 5, role: 1, permission: 5 }, // مدير النظام - تحرير البيانات
        { id: 6, role: 1, permission: 6 }, // مدير النظام - حذف البيانات
        { id: 7, role: 1, permission: 7 }, // مدير النظام - إنشاء التقارير
        { id: 8, role: 1, permission: 8 }, // مدير النظام - تصدير البيانات
        { id: 9, role: 1, permission: 9 }, // مدير النظام - إدارة الخرائط
        { id: 10, role: 1, permission: 10 }, // مدير النظام - إدارة المشاريع
        { id: 11, role: 1, permission: 11 }, // مدير النظام - إدارة اللجان
        { id: 12, role: 1, permission: 12 }, // مدير النظام - إعدادات النظام
        
        { id: 13, role: 2, permission: 1 }, // مشرف - إدارة المستخدمين
        { id: 14, role: 2, permission: 4 }, // مشرف - عرض البيانات
        { id: 15, role: 2, permission: 5 }, // مشرف - تحرير البيانات
        { id: 16, role: 2, permission: 7 }, // مشرف - إنشاء التقارير
        { id: 17, role: 2, permission: 8 }, // مشرف - تصدير البيانات
        { id: 18, role: 2, permission: 9 }, // مشرف - إدارة الخرائط
        { id: 19, role: 2, permission: 10 }, // مشرف - إدارة المشاريع
        { id: 20, role: 2, permission: 11 }, // مشرف - إدارة اللجان
        
        { id: 21, role: 3, permission: 4 }, // محرر - عرض البيانات
        { id: 22, role: 3, permission: 5 }, // محرر - تحرير البيانات
        { id: 23, role: 3, permission: 7 }, // محرر - إنشاء التقارير
        { id: 24, role: 3, permission: 8 }, // محرر - تصدير البيانات
        
        { id: 25, role: 4, permission: 4 }, // مشاهد - عرض البيانات
        { id: 26, role: 4, permission: 7 }, // مشاهد - إنشاء التقارير
        
        { id: 27, role: 5, permission: 4 }, // محلل بيانات - عرض البيانات
        { id: 28, role: 5, permission: 7 }, // محلل بيانات - إنشاء التقارير
        { id: 29, role: 5, permission: 8 }, // محلل بيانات - تصدير البيانات
        { id: 30, role: 5, permission: 9 }  // محلل بيانات - إدارة الخرائط
      ];

      // Local storage keys
      const STORAGE_KEYS = {
        ROLES: 'mock_roles',
        PERMISSIONS: 'mock_permissions',
        ROLE_PERMISSIONS: 'mock_role_permissions'
      };

      // Initialize mock data in localStorage if not exists
      function initializeMockData() {
        if (!localStorage.getItem(STORAGE_KEYS.ROLES)) {
          localStorage.setItem(STORAGE_KEYS.ROLES, JSON.stringify(mockRoles));
        }
        if (!localStorage.getItem(STORAGE_KEYS.PERMISSIONS)) {
          localStorage.setItem(STORAGE_KEYS.PERMISSIONS, JSON.stringify(mockPermissions));
        }
        if (!localStorage.getItem(STORAGE_KEYS.ROLE_PERMISSIONS)) {
          localStorage.setItem(STORAGE_KEYS.ROLE_PERMISSIONS, JSON.stringify(mockRolePermissions));
        }
      }

      // Get JWT token from localStorage (kept for compatibility)
      function getAuthToken() {
        return localStorage.getItem("access_token");
      }

      // Mock API Helper function
      async function apiCall(endpoint, options = {}) {
        // Simulate network delay (shorter for demo mode)
        await new Promise(resolve => setTimeout(resolve, 150));

        try {
          // Handle different endpoints
          if (endpoint === "/api/roles/") {
            const rolesData = JSON.parse(localStorage.getItem(STORAGE_KEYS.ROLES) || '[]');
            return rolesData;
          }
          
          if (endpoint === "/api/permissions/") {
            const permissionsData = JSON.parse(localStorage.getItem(STORAGE_KEYS.PERMISSIONS) || '[]');
            return permissionsData;
          }
          
          if (endpoint === "/api/role-permissions/") {
            const rolePermissionsData = JSON.parse(localStorage.getItem(STORAGE_KEYS.ROLE_PERMISSIONS) || '[]');
            return rolePermissionsData;
          }

          // Handle POST requests for role-permissions
          if (endpoint === "/api/role-permissions/" && options.method === "POST") {
            const body = JSON.parse(options.body);
            const rolePermissionsData = JSON.parse(localStorage.getItem(STORAGE_KEYS.ROLE_PERMISSIONS) || '[]');
            
            const newRolePermission = {
              id: Date.now() + Math.random(),
              role: body.role,
              permission: body.permission
            };
            
            rolePermissionsData.push(newRolePermission);
            localStorage.setItem(STORAGE_KEYS.ROLE_PERMISSIONS, JSON.stringify(rolePermissionsData));
            
            return { success: true, data: newRolePermission };
          }

          // Handle DELETE requests for role-permissions
          if (endpoint.includes("/api/role-permissions/") && options.method === "DELETE") {
            const id = parseInt(endpoint.split("/").pop());
            const rolePermissionsData = JSON.parse(localStorage.getItem(STORAGE_KEYS.ROLE_PERMISSIONS) || '[]');
            
            const filteredData = rolePermissionsData.filter(rp => rp.id !== id);
            localStorage.setItem(STORAGE_KEYS.ROLE_PERMISSIONS, JSON.stringify(filteredData));
            
            return { success: true };
          }

          return { success: true };
        } catch (error) {
          console.error("Mock API call failed:", error);
          throw error;
        }
      }

      // Enhanced Notification System
      function showNotification(type, message, title = "") {
        const notificationContainer = document.getElementById(
          "notificationContainer"
        );

        // Create notification element
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;

        // Select appropriate icon based on type
        let icon = "";
        switch (type) {
          case "success":
            icon = "fas fa-check-circle";
            break;
          case "error":
            icon = "fas fa-exclamation-circle";
            break;
          case "warning":
            icon = "fas fa-exclamation-triangle";
            break;
          case "info":
            icon = "fas fa-info-circle";
            break;
          default:
            icon = "fas fa-info-circle";
        }

        notification.innerHTML = `
          <i class="${icon} notification-icon"></i>
          <div class="notification-content">
            ${title ? `<div class="notification-title">${title}</div>` : ""}
            <div class="notification-message">${message}</div>
          </div>
          <button class="notification-close" onclick="closeNotification(this.parentElement)">
            <i class="fas fa-times"></i>
          </button>
        `;

        // Add notification to container
        notificationContainer.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            closeNotification(notification);
          }
        }, 5000);
      }

      function closeNotification(notification) {
        notification.classList.add("slide-out");
        setTimeout(() => {
          if (notification.parentElement) {
            notification.parentElement.removeChild(notification);
          }
        }, 300);
      }

      // Helper functions for specific notification types
      function showSuccessNotification(messageKey, title = "") {
        const message = translations[currentLang].notifications[messageKey];
        showNotification("success", message, title);
      }

      function showErrorNotification(
        messageKey,
        title = "",
        customMessage = ""
      ) {
        const message =
          customMessage || translations[currentLang].notifications[messageKey];
        showNotification("error", message, title);
      }

      function showInfoNotification(messageKey, title = "") {
        const message = translations[currentLang].notifications[messageKey];
        showNotification("info", message, title);
      }

      function showWarningNotification(messageKey, title = "") {
        const message = translations[currentLang].notifications[messageKey];
        showNotification("warning", message, title);
      }

      // Legacy support - update old calls to use new system
      function showNotificationLegacy(message, type = "info") {
        showNotification(type, message);
      }

      // Fetch all roles
      async function fetchRoles() {
        try {
          const data = await apiCall("/api/roles/");
          roles = Array.isArray(data) ? data : (data && data.results) || [];
          return roles;
        } catch (error) {
          console.error("Error fetching roles:", error);
          showErrorNotification("fetchRolesError", "", error.message);
          return [];
        }
      }

      // Fetch all permissions
      async function fetchPermissions() {
        try {
          const data = await apiCall("/api/permissions/");
          permissions = Array.isArray(data)
            ? data
            : (data && data.results) || [];
          return permissions;
        } catch (error) {
          console.error("Error fetching permissions:", error);
          showErrorNotification("fetchPermissionsError", "", error.message);
          return [];
        }
      }

      // Fetch role permissions
      async function fetchRolePermissions() {
        try {
          const data = await apiCall("/api/role-permissions/");
          rolePermissions = Array.isArray(data)
            ? data
            : (data && data.results) || [];
          return rolePermissions;
        } catch (error) {
          console.error("Error fetching role permissions:", error);
          showErrorNotification("fetchRolePermissionsError", "", error.message);
          return [];
        }
      }

      // Get permissions for a specific role
      function getPermissionsForRole(roleId) {
        return rolePermissions
          .filter((rp) => rp.role === roleId)
          .map((rp) => rp.permission);
      }

      // Check if role has permission
      function roleHasPermission(roleId, permissionId) {
        return rolePermissions.some(
          (rp) => rp.role === roleId && rp.permission === permissionId
        );
      }

      // Display roles and permissions in table
      function displayRolePermissions() {
        const tbody = document.getElementById("rolePermissionsTableBody");
        tbody.innerHTML = "";

        roles.forEach((role) => {
          const row = document.createElement("tr");

          // Role name cell - Simple and clean
          const roleNameCell = document.createElement("td");
          roleNameCell.innerHTML = `
            <div class="d-flex px-2 py-1">
              <div class="d-flex flex-column justify-content-center">
                <div class="role-name-cell">${role.role_name}</div>
                ${
                  role.description
                    ? `<div class="role-description">${role.description}</div>`
                    : ""
                }
              </div>
            </div>
          `;

          // Current permissions count cell
          const currentPermissionsCell = document.createElement("td");
          currentPermissionsCell.className = "align-middle text-center";
          const currentPermissionIds = getPermissionsForRole(role.id);
          const permissionsCount = currentPermissionIds.length;

          currentPermissionsCell.innerHTML = `
            <div class="count-badge">
              <i class="fas fa-shield-alt"></i>
              <span>${permissionsCount} ${
            permissionsCount === 1 ? "صلاحية" : "سماحيات"
          }</span>
            </div>
          `;

          // Available permissions cell (multi-select dropdown)
          const availablePermissionsCell = document.createElement("td");
          availablePermissionsCell.className = "align-middle";

          // Create container for select and instructions
          const selectContainer = document.createElement("div");

          const permissionsSelect = document.createElement("select");
          permissionsSelect.className = "permissions-select";
          permissionsSelect.multiple = true;
          permissionsSelect.setAttribute("data-role-id", role.id);
          permissionsSelect.setAttribute("size", "6"); // Show multiple options at once

          // Add options for all permissions
          permissions.forEach((permission) => {
            const option = document.createElement("option");
            option.value = permission.id;
            option.textContent = permission.permission_name;
            option.selected = roleHasPermission(role.id, permission.id);
            permissionsSelect.appendChild(option);
          });

          // Add instructions text
          const instructionsDiv = document.createElement("div");
          instructionsDiv.className = "select-instructions";
          instructionsDiv.textContent =
            currentLang === "ar"
              ? "اضغط Ctrl + النقر لاختيار عدة سماحيات"
              : "Ctrl + Click to select multiple";

          // Add event listener for select changes
          permissionsSelect.addEventListener("change", function () {
            onPermissionSelectChange(this, role.id);
          });

          // Enhance multiple selection behavior
          permissionsSelect.addEventListener("mousedown", function (e) {
            e.preventDefault();
            const option = e.target;
            if (option.tagName === "OPTION") {
              option.selected = !option.selected;
              // Trigger change event manually
              this.dispatchEvent(new Event("change"));
              return false;
            }
          });

          // Additional keyboard support for better UX
          permissionsSelect.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              const focusedOption = this.options[this.selectedIndex];
              if (focusedOption) {
                focusedOption.selected = !focusedOption.selected;
                this.dispatchEvent(new Event("change"));
              }
            }
          });

          selectContainer.appendChild(permissionsSelect);
          selectContainer.appendChild(instructionsDiv);
          availablePermissionsCell.appendChild(selectContainer);

          row.appendChild(roleNameCell);
          row.appendChild(currentPermissionsCell);
          row.appendChild(availablePermissionsCell);

          tbody.appendChild(row);
        });
      }

      // Handle permission checkbox change
      function onPermissionChange(event) {
        const checkbox = event.target;
        const roleId = parseInt(checkbox.getAttribute("data-role-id"));
        const permissionId = parseInt(
          checkbox.getAttribute("data-permission-id")
        );

        if (checkbox.checked) {
          // Add permission to role
          if (!roleHasPermission(roleId, permissionId)) {
            rolePermissions.push({
              role: roleId,
              permission: permissionId,
              // We'll assign proper IDs when saving to server
              id: Date.now(), // Temporary ID for local tracking
            });
          }
        } else {
          // Remove permission from role
          rolePermissions = rolePermissions.filter(
            (rp) => !(rp.role === roleId && rp.permission === permissionId)
          );
        }

        // Update the current permissions display
        updateCurrentPermissionsDisplay();
      }

      // Handle permission select changes
      function onPermissionSelectChange(selectElement, roleId) {
        const selectedOptions = Array.from(selectElement.selectedOptions);
        const selectedPermissionIds = selectedOptions.map((option) =>
          parseInt(option.value)
        );

        // Remove all existing permissions for this role from rolePermissions
        rolePermissions = rolePermissions.filter((rp) => rp.role !== roleId);

        // Add selected permissions to rolePermissions
        selectedPermissionIds.forEach((permissionId) => {
          rolePermissions.push({
            role: roleId,
            permission: permissionId,
            id: Date.now() + Math.random(), // Temporary ID for local tracking
          });
        });

        // Update the count display
        updatePermissionCount(roleId, selectedPermissionIds.length);

        console.log("Role permissions updated:", rolePermissions);
      }

      // Update permission count display
      function updatePermissionCount(roleId, count) {
        const row = document
          .querySelector(`select[data-role-id="${roleId}"]`)
          .closest("tr");
        const countBadge = row.querySelector(".count-badge span");
        if (countBadge) {
          const text =
            currentLang === "ar"
              ? `${count} ${count === 1 ? "صلاحية" : "سماحيات"}`
              : `${count} ${count === 1 ? "Permission" : "Permissions"}`;
          countBadge.textContent = text;
        }
      }

      // Update current permissions display
      function updateCurrentPermissionsDisplay() {
        const tbody = document.getElementById("rolePermissionsTableBody");
        const rows = tbody.querySelectorAll("tr");

        rows.forEach((row, index) => {
          const role = roles[index];
          const currentPermissionIds = getPermissionsForRole(role.id);
          const permissionsCount = currentPermissionIds.length;

          // Update count badge
          const countBadge = row.querySelector(".count-badge span");
          if (countBadge) {
            const text =
              currentLang === "ar"
                ? `${permissionsCount} ${
                    permissionsCount === 1 ? "صلاحية" : "سماحيات"
                  }`
                : `${permissionsCount} ${
                    permissionsCount === 1 ? "Permission" : "Permissions"
                  }`;
            countBadge.textContent = text;
          }

          // Update select options
          const selectElement = row.querySelector(".permissions-select");
          if (selectElement) {
            Array.from(selectElement.options).forEach((option) => {
              option.selected = currentPermissionIds.includes(
                parseInt(option.value)
              );
            });
          }
        });
      }

      // Save all changes to localStorage
      async function saveAllChanges() {
        try {
          showInfoNotification("savingChanges");

          // Get current role permissions from localStorage
          const currentServerRolePermissions = JSON.parse(
            localStorage.getItem(STORAGE_KEYS.ROLE_PERMISSIONS) || '[]'
          );

          // Calculate changes needed
          const changes = [];

          // Check for permissions to add and remove for each role
          roles.forEach((role) => {
            const currentLocalPermissionIds = getPermissionsForRole(role.id);
            const currentServerPermissionIds = currentServerRolePermissions
              .filter((rp) => rp.role === role.id)
              .map((rp) => rp.permission);

            // Permissions to add
            const toAdd = currentLocalPermissionIds.filter(
              (permId) => !currentServerPermissionIds.includes(permId)
            );

            // Permissions to remove
            const toRemove = currentServerPermissionIds.filter(
              (permId) => !currentLocalPermissionIds.includes(permId)
            );

            // Add operations
            toAdd.forEach((permissionId) => {
              changes.push({
                action: "add",
                role: role.id,
                permission: permissionId,
              });
            });

            // Remove operations
            toRemove.forEach((permissionId) => {
              const serverRolePermission = currentServerRolePermissions.find(
                (rp) => rp.role === role.id && rp.permission === permissionId
              );
              if (serverRolePermission) {
                changes.push({
                  action: "remove",
                  id: serverRolePermission.id,
                });
              }
            });
          });

          // Execute changes
          let successCount = 0;
          let errorCount = 0;

          for (const change of changes) {
            try {
              if (change.action === "add") {
                await apiCall("/api/role-permissions/", {
                  method: "POST",
                  body: JSON.stringify({
                    role: change.role,
                    permission: change.permission,
                  }),
                });
                successCount++;
              } else if (change.action === "remove") {
                await apiCall(`/api/role-permissions/${change.id}/`, {
                  method: "DELETE",
                });
                successCount++;
              }
            } catch (error) {
              console.error("Error saving change:", error);
              errorCount++;
            }
          }

          if (errorCount === 0) {
            const successMessage =
              currentLang === "ar"
                ? `تم حفظ جميع التغييرات بنجاح (${successCount} عملية)`
                : `All changes saved successfully (${successCount} operations)`;
            showSuccessNotification("saveSuccess", "", successMessage);
            // Refresh data from localStorage
            await loadAllData();
          } else if (successCount > 0) {
            const partialMessage =
              currentLang === "ar"
                ? `تم حفظ ${successCount} تغيير، فشل في ${errorCount} عمليات`
                : `${successCount} changes saved, ${errorCount} operations failed`;
            showWarningNotification("savePartial", "", partialMessage);
          } else {
            showErrorNotification("saveError");
          }
        } catch (error) {
          console.error("Error saving changes:", error);
          showErrorNotification("saveError", "", error.message);
        }
      }

      // Load all data
      async function loadAllData() {
        document.getElementById("loadingIndicator").style.display = "block";
        document.getElementById("tableContainer").style.display = "none";

        try {
          // Initialize mock data
          initializeMockData();

          // Fetch all data in parallel
          await Promise.all([
            fetchRoles(),
            fetchPermissions(),
            fetchRolePermissions(),
          ]);

          // Display the data
          displayRolePermissions();

          document.getElementById("loadingIndicator").style.display = "none";
          document.getElementById("tableContainer").style.display = "block";
          
          // Show success message for demo mode
          const loadMessage = currentLang === "ar" 
            ? "تم تحميل البيانات بنجاح (وضع التجربة)" 
            : "Data loaded successfully (Demo Mode)";
          showInfoNotification("loadSuccess", "", loadMessage);
        } catch (error) {
          console.error("Error loading data:", error);
          showErrorNotification("loadError", "", error.message);
          document.getElementById("loadingIndicator").style.display = "none";
        }
      }

      // Reset data to default state
      function resetToDefault() {
        const confirmMessage = translations[currentLang].resetConfirmMessage;
        if (confirm(confirmMessage)) {
          // Clear localStorage
          localStorage.removeItem(STORAGE_KEYS.ROLES);
          localStorage.removeItem(STORAGE_KEYS.PERMISSIONS);
          localStorage.removeItem(STORAGE_KEYS.ROLE_PERMISSIONS);
          
          // Reinitialize mock data
          initializeMockData();
          
          // Reload data
          loadAllData();
          
          const successMessage = translations[currentLang].resetSuccessMessage;
          showSuccessNotification("loadSuccess", "", successMessage);
        }
      }

      // Wait for DOM to be fully loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Function to handle zoom level changes
        function handleZoom() {
          const sidenav = document.getElementById("sidenav-main");
          const windowWidth = window.innerWidth;
          const zoomLevel = window.devicePixelRatio;

          if (zoomLevel > 1.51 || windowWidth < 1200) {
            sidenav.style.display = "none";
          } else {
            sidenav.style.display = "block";
          }
        }

        // Initial check
        handleZoom();

        // Listen for zoom changes
        window.addEventListener("resize", handleZoom);

        // Initialize scrollbar
        var win = navigator.platform.indexOf("Win") > -1;
        if (win && document.querySelector("#sidenav-scrollbar")) {
          var options = {
            damping: "0.5",
          };
          Scrollbar.init(document.querySelector("#sidenav-scrollbar"), options);
        }

        // Load all data when page loads
        loadAllData();
      });
    </script>
    <script>
      var win = navigator.platform.indexOf("Win") > -1;
      if (win && document.querySelector("#sidenav-scrollbar")) {
        var options = {
          damping: "0.5",
        };
        Scrollbar.init(document.querySelector("#sidenav-scrollbar"), options);
      }
    </script>

    <!-- Language Toggle Script -->
    <script>
      const translations = {
        ar: {
          dir: "rtl",
          dashboard: "لوحة التحكم",
          configTables: "جداول الإعدادات",
          maps: "الخرائط",
          manageUsers: "إدارة المستخدمين ",
          langToggleText: "تغيير اللغة",
          signIn: "تسجيل الدخول",
          signUp: "إنشاء حساب",
          families: "عدد الأسر",
          validBuildings: "منشآت صالحة",
          residentialBuildings: "منشآت سكنية",
          threatened: "مهددة بالإزالة",
          constructionStatus: "الوضع الإنشائي",
          educationStatus: "الوضع التعليمي",
          healthStatus: "الوضع الصحي",
          footerText: "© 2025، جميع الحقوق محفوظة،",
          companyName: "دار التقنية الحديثة",
          settingsText: "الإعدادات",
          logoutText: "تسجيل الخروج",
          neighborhoodCommittees: "إدارة لجان الأحياء",
          developmentCommittees: "إدارة لجان التنمية والتطوع",
          projectsOverview: "نظرة عامة على المشاريع",
          moreIn2024: "زيادة بنسبة 4% في 2024",
          projectCompletion: "معدل إكمال المشاريع في حلب",
          foodProjects: "مشاريع الغذاء",
          healthProjects: "مشاريع الصحة",
          clothingProjects: "مشاريع الملابس والمساعدات السكنية",
          viewAllProjects: "عرض جميع المشاريع",
          projects: "المشاريع",
          projectName: "اسم المشروع",
          type: "النوع",
          budget: "الميزانية",
          status: "الحالة",
          projectOrders: "طلبات المشاريع",
          thisMonth: "هذا الشهر",
          timeline: [
            { title: "أغذية", date: "٢٨ كانون الأول ٢٠٢٥" },
            { title: "صحة", date: "١٦ نيسان ٢٠٢٥" },
            { title: "ملابس ومساعدات سكنية", date: "١٧ نيسان ٢٠٢٥" },
            { title: "سكن وإقامة", date: "٢٠ كانون الأول ٢٠٢٥" },
            { title: "تعليم", date: "٠٥ تشرين الثاني ٢٠٢٥" },
            { title: "دعم نفسي وأسري", date: "١٧ كانون الأول ٢٠٢٥" },
          ],
          chartLabels: {
            construction: ["صالح", "متصدع", "متهالك", "جيد"],
            health: ["مشفى", "مستوصف", "عيادة متنقلة", "عيادة"],
            education: ["جامعة", "مدرسة", "مدارس خاصة", "روضات"],
            service: ["مياه", "كهرباء", "صرف صحي", "لا شيء"],
          },
          // Assign Role Permission Page Specific Translations
          pageTitle: "ربط الأدوار بالسماحيات",
          roleNameHeader: "اسم الدور",
          currentPermissionsHeader: "عدد السماحيات",
          availablePermissionsHeader: "اختيار السماحيات",
          saveChangesText: "حفظ التغييرات",
          demoModeTitle: "وضع التجربة:",
          demoModeText: "هذه الصفحة تعمل بدون خادم خلفي. جميع البيانات محفوظة محلياً في المتصفح.",
          resetButtonText: "إعادة تعيين",
          resetConfirmMessage: "هل أنت متأكد من إعادة تعيين جميع البيانات إلى الحالة الافتراضية؟",
          resetSuccessMessage: "تم إعادة تعيين البيانات بنجاح",
          notifications: {
            loadSuccess: "تم تحميل البيانات بنجاح (وضع التجربة)",
            loadError: "فشل في تحميل البيانات",
            saveSuccess: "تم حفظ التغييرات بنجاح (محلياً)",
            saveError: "فشل في حفظ التغييرات",
            savePartial: "تم حفظ بعض التغييرات",
            fetchRolesError: "فشل في جلب الأدوار",
            fetchPermissionsError: "فشل في جلب السماحيات",
            fetchRolePermissionsError: "فشل في جلب ربط الأدوار بالسماحيات",
            networkError: "خطأ في الاتصال بالخادم",
            sessionExpired: "انتهت صلاحية الجلسة، يرجى تسجيل الدخول مرة أخرى",
            savingChanges: "جاري حفظ التغييرات...",
            loadingData: "جاري تحميل البيانات...",
          },
        },
        en: {
          neighborhoodCommittees: "Neighborhood Comm",
          developmentCommittees: "Development Comm",
          dir: "ltr",
          dashboard: "Dashboard",
          configTables: "Configuration Tables",
          maps: "Maps",
          manageUsers: "Manage Users",
          langToggleText: "Change Language",
          signIn: "Sign In",
          signUp: "Sign Up",
          families: "Families",
          validBuildings: "Valid Buildings",
          residentialBuildings: "Residential Buildings",
          threatened: "Threatened with Removal",
          constructionStatus: "Construction Status",
          educationStatus: "Education Status",
          healthStatus: "Health Status",
          footerText: "© 2025, All rights reserved,",
          companyName: "Hi-Tech House",
          settingsText: "Settings",
          logoutText: "Logout",
          projectsOverview: "Projects Foods And Health overview",
          moreIn2024: "4% more in 2024",
          projectCompletion: "Project completion rate in Aleppo",
          foodProjects: "Food Projects",
          healthProjects: "Health Projects",
          clothingProjects: "Clothing and housing benefits Projects",
          viewAllProjects: "View all Projects",
          projects: "Projects",
          projectName: "NAME OF PROJECT",
          type: "TYPE",
          budget: "BUDGET",
          status: "STATUS",
          projectOrders: "Projects Orders overview",
          thisMonth: "this month",
          timeline: [
            { title: "Foods", date: "28 DEC 2025" },
            { title: "Health", date: "16 Apr 2025" },
            { title: "Clothing and housing benefits", date: "17 Apr 2025" },
            { title: "Housing and accommodation", date: "20 DEC 2025" },
            { title: "Education", date: "05 Nov 2025" },
            { title: "Psychological and family support", date: "17 DEC 2025" },
          ],
          chartLabels: {
            construction: ["Valid", "Cracked", "Dilapidated", "Good"],
            health: ["Hospital", "Clinic", "Mobile Clinic", "Polyclinic"],
            education: [
              "University",
              "School",
              "Private Schools",
              "Kindergartens",
            ],
            service: ["Water", "Electricity", "Sanitation", "None"],
          },
          // Assign Role Permission Page Specific Translations
          pageTitle: "Assign Role Permissions",
          roleNameHeader: "Role Name",
          currentPermissionsHeader: "Permissions Count",
          availablePermissionsHeader: "Select Permissions",
          saveChangesText: "Save Changes",
          demoModeTitle: "Demo Mode:",
          demoModeText: "This page works without a backend server. All data is stored locally in the browser.",
          resetButtonText: "Reset",
          resetConfirmMessage: "Are you sure you want to reset all data to default state?",
          resetSuccessMessage: "Data reset successfully",
          notifications: {
            loadSuccess: "Data loaded successfully (Demo Mode)",
            loadError: "Failed to load data",
            saveSuccess: "Changes saved successfully (locally)",
            saveError: "Failed to save changes",
            savePartial: "Some changes were saved",
            fetchRolesError: "Failed to fetch roles",
            fetchPermissionsError: "Failed to fetch permissions",
            fetchRolePermissionsError: "Failed to fetch role permissions",
            networkError: "Network connection error",
            sessionExpired: "Session expired, please login again",
            savingChanges: "Saving changes...",
            loadingData: "Loading data...",
          },
        },
      };

      let currentLang = "ar";

      function switchLanguage(lang) {
        // Store the language preference in localStorage
        try {
          localStorage.setItem("preferredLanguage", lang);
        } catch (error) {
          console.error("Error saving language preference:", error);
        }

        // Update aside (sidebar) position based on language
        const aside = document.getElementById("sidenav-main");

        aside.classList.remove("fixed-end", "fixed-start");

        // Update dropdown button container alignment based on language
        const dropdownContainer = document.getElementById(
          "dropdownButtonContainer"
        );
        const projectsTitleContainer = document.getElementById(
          "projectsTitleContainer"
        );
        const helpButton = document.getElementById("helpButton");

        if (lang === "ar") {
          aside.classList.add("fixed-end");
          // For RTL (Arabic)
          if (dropdownContainer) dropdownContainer.classList.remove("text-end");
          if (dropdownContainer) dropdownContainer.classList.add("text-start");
          if (projectsTitleContainer)
            projectsTitleContainer.classList.remove("text-start");
          if (projectsTitleContainer)
            projectsTitleContainer.classList.add("text-end");

          // Position help button on the left side for Arabic
          if (helpButton) {
            helpButton.style.left = "20px";
            helpButton.style.right = "auto";
          }
        } else {
          aside.classList.add("fixed-start");
          // For LTR (English)
          if (dropdownContainer)
            dropdownContainer.classList.remove("text-start");
          if (dropdownContainer) dropdownContainer.classList.add("text-end");
          if (projectsTitleContainer)
            projectsTitleContainer.classList.remove("text-end");
          if (projectsTitleContainer)
            projectsTitleContainer.classList.add("text-start");

          // Position help button on the right side for English
          if (helpButton) {
            helpButton.style.right = "20px";
            helpButton.style.left = "auto";
          }
        }

        // Update document direction

        currentLang = lang;
        const t = translations[lang];

        // Update document direction
        document.documentElement.lang = lang;
        document.documentElement.dir = t.dir;

        // Update aside (sidebar) text
        const navTexts = document.querySelectorAll(".nav-link .nav-link-text");
        if (navTexts[0]) navTexts[0].textContent = t.dashboard;
        if (navTexts[1]) navTexts[1].textContent = t.configTables;
        if (navTexts[2]) navTexts[2].textContent = t.manageUsers;
        if (navTexts[3]) navTexts[3].textContent = t.neighborhoodCommittees;
        if (navTexts[4]) navTexts[4].textContent = t.developmentCommittees;

        const langToggleText = document.getElementById("langToggleText");
        if (langToggleText) langToggleText.textContent = t.langToggleText;

        // Update header menu items (settings/logout)
        const settingsText = document.getElementById("settingsText");
        if (settingsText) settingsText.textContent = t.settingsText;
        const logoutText = document.getElementById("logoutText");
        if (logoutText) logoutText.textContent = t.logoutText;

        // Update page-specific elements
        const pageTitle = document.getElementById("pageTitle");
        if (pageTitle) pageTitle.textContent = t.pageTitle;

        const roleNameHeader = document.getElementById("roleNameHeader");
        if (roleNameHeader) roleNameHeader.textContent = t.roleNameHeader;

        const currentPermissionsHeader = document.getElementById(
          "currentPermissionsHeader"
        );
        if (currentPermissionsHeader)
          currentPermissionsHeader.innerHTML =
            lang === "ar"
              ? '<i class="fas fa-chart-bar me-1"></i>' +
                t.currentPermissionsHeader
              : '<i class="fas fa-chart-bar me-1"></i>' +
                t.currentPermissionsHeader;

        const availablePermissionsHeader = document.getElementById(
          "availablePermissionsHeader"
        );
        if (availablePermissionsHeader)
          availablePermissionsHeader.innerHTML =
            lang === "ar"
              ? '<i class="fas fa-list-check me-1"></i>' +
                t.availablePermissionsHeader
              : '<i class="fas fa-list-check me-1"></i>' +
                t.availablePermissionsHeader;

        const saveChangesText = document.getElementById("saveChangesText");
        if (saveChangesText) saveChangesText.textContent = t.saveChangesText;

        // Update demo mode notice
        const demoModeTitle = document.getElementById("demoModeTitle");
        if (demoModeTitle) demoModeTitle.textContent = t.demoModeTitle;
        
        const demoModeText = document.getElementById("demoModeText");
        if (demoModeText) demoModeText.textContent = t.demoModeText;

        // Update reset button text
        const resetButton = document.querySelector('button[onclick="resetToDefault()"] span');
        if (resetButton) resetButton.textContent = t.resetButtonText;

        // Update instructions text for all permission selects
        const instructionsDivs = document.querySelectorAll(
          ".select-instructions"
        );
        instructionsDivs.forEach((div) => {
          div.textContent =
            lang === "ar"
              ? "اضغط Ctrl + النقر لاختيار عدة سماحيات"
              : "Ctrl + Click to select multiple";
        });
      }

      function toggleLanguage() {
        if (currentLang === "ar") {
          switchLanguage("en");
        } else {
          switchLanguage("ar");
        }
      }

      function logout() {
        window.location.href = "./index.html"; // Redirect to index.html (login page)
      }

      // Add menu functionality
      function toggleMenu() {
        const menu = document.getElementById("menuDropdown");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
      }

      // Close menu when clicking outside
      document.addEventListener("click", function (e) {
        const menu = document.getElementById("menuDropdown");
        const menuBtn = document.getElementById("menuToggleBtn");

        if (menu && menuBtn) {
          if (!menuBtn.contains(e.target) && !menu.contains(e.target)) {
            menu.style.display = "none";
          }
        }
      });

      // Initial language setup
      document.addEventListener("DOMContentLoaded", function () {
        // Check if there's a saved language preference in localStorage
        let savedLanguage;
        try {
          savedLanguage = localStorage.getItem("preferredLanguage");
        } catch (error) {
          console.error("Error retrieving language preference:", error);
          savedLanguage = null;
        }

        // Set initial language based on saved preference or default to Arabic
        const initialLang = savedLanguage || "ar";
        switchLanguage(initialLang); // Apply the language switch

        // Initialize language toggle functionality
        // The language toggle is now handled through the menu dropdown
      });
    </script>
  </body>
</html>
